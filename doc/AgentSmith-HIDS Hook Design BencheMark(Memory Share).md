## AgentSmith-HIDS Hook Design BencheMark(Memory Share)

​														        **By Dianrong InfoSEC**



| 测试版本 | Hook Syscall                            |
| -------- | --------------------------------------- |
| v0.1     | execve,connect,init_module,finit_module |



| 测试服务器 | 配置信息                                                     |
| ---------- | ------------------------------------------------------------ |
| Server1    | OS: GNU/Linux -- 3.10.0-862.14.4.el7.x86_64 <br/>CPU(4): Intel(R) Core(TM) i7-4870HQ CPU @ 2.50GHz (4989.4 bogomips) |



#### 一:测试Hook Execve Syscall 耗时

测试服务器:Server1

测试环境:30 * while(true) uname

| 总请求数     | 1372949  |
| ------------ | -------- |
| QPS          | 4160.45  |
| 平均耗时(ns) | 7194.75  |
| 中位数(ns)   | 4823.0   |
| 99分位(ns)   | 17116.81 |
| 95分位(ns)   | 8061.0   |
| 90分位(ns)   | 6718.0   |
| 80分位(ns)   | 6085.0   |
| 70分位(ns)   | 5561.0   |



#### 二:测试Hook Connect Syscall耗时

测试服务器:Server1

测试工具:wrk 4.1.0

测试环境:./wrk -c20 -d3600 -t8   目标服务器keepalive_timeout=1



测试一:No Hook,测试connect的耗时

| 总请求数     | 40717229  |
| ------------ | --------- |
| QPS          | 11310.08  |
| 平均耗时(ns) | 52983.83  |
| 中位数(ns)   | 16277.0   |
| 99分位(ns)   | 305792.75 |
| 95分位(ns)   | 177617.5  |
| 90分位(ns)   | 137119.0  |
| 80分位(ns)   | 96576.0   |
| 70分位(ns)   | 67924.0   |



测试二:Hook,测试Hook方案自身的耗时

| 总请求数     | 41610071 | Loss(%) |
| ------------ | -------- | ------- |
| QPS          | 11558.10 | NULL    |
| 平均耗时(ns) | 11501.52 | 21.70%  |
| 中位数(ns)   | 8478.0   | 52.08%  |
| 99分位(ns)   | 69062.79 | 22.58%  |
| 95分位(ns)   | 20793.0  | 11.70%  |
| 90分位(ns)   | 14776.79 | 10.77%  |
| 80分位(ns)   | 10626.0  | 11.0%   |
| 70分位(ns)   | 9676.0   | 14.24%  |



#### 三:Hook稳定性/性能测试

测试服务器:Server1

测试工具:wrk 4.1.0; sysstat 10.1.5

测试环境:wrk -c20 -d3600 -t8

​		30 * while(true) uname

​		user层接收端sleep:10ns



wrk数据:

| 总请求数     | 29956488 |
| ------------ | -------- |
| QPS          | 8320.87  |
| Transfer/sec | 6.74MB   |



CPU占用(usr+system+guest):

| 最大值 | 11.0% |
| ------ | ----- |
| 最小值 | 4.95% |
| 均值   | 8.02% |



Mem占用:

| 物理内存(RSS)        | 稳定348KB  |
| -------------------- | ---------- |
| 虚拟内存(VSZ)        | 稳定6392KB |
| kernel-user 共享内存 | 2MB        |

(注:该测试目标为用户层接收程序的最小程序,即不包括数据传输模块,仅包含用户层和内核Agent通讯模块)